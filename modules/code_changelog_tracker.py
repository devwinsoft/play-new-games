#!/usr/bin/env python3
"""
Code Changelog Tracker
AIê°€ ë§Œë“  ëª¨ë“  ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ reviews í´ë”ì— ê¸°ë¡í•˜ê³  HTML ë·°ì–´ë¡œ í™•ì¸
"""
import os
import json
import subprocess
from datetime import datetime
from pathlib import Path
from typing import Optional, List, Dict, Any


class CodeChangeLogger:
    """ì½”ë“œ ë³€ê²½ì‚¬í•­ ë¡œê±°"""
    
    def __init__(
        self,
        project_name: str,
        user_request: str = "",
        reviews_dir: str = "reviews",
        port: int = 4000
    ):
        """
        Args:
            project_name: í”„ë¡œì íŠ¸ ì´ë¦„
            user_request: ì‚¬ìš©ì ìš”êµ¬ì‚¬í•­
            reviews_dir: ë¬¸ì„œ ì €ì¥ ë””ë ‰í† ë¦¬
            port: HTTP ì„œë²„ í¬íŠ¸
        """
        self.project_name = project_name
        self.user_request = user_request
        self.reviews_dir = Path(reviews_dir)
        self.port = port
        
        # íƒ€ì„ìŠ¤íƒ¬í”„
        self.timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        
        # ë³€ê²½ì‚¬í•­ ëª©ë¡
        self.changes: List[Dict[str, Any]] = []
        
        # reviews ë””ë ‰í† ë¦¬ ìƒì„±
        self.reviews_dir.mkdir(exist_ok=True)
        
        # README.md ì´ˆê¸°í™” (ì—†ìœ¼ë©´)
        self._init_readme()
    
    def _init_readme(self):
        """README.md ì´ˆê¸°í™”"""
        readme_path = self.reviews_dir / "README.md"
        if not readme_path.exists():
            content = f"""# {self.project_name} - ì½”ë“œ ë³€ê²½ ì´ë ¥

ì´ ë¬¸ì„œëŠ” AIê°€ ìƒì„±í•œ ëª¨ë“  ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ê¸°ë¡í•©ë‹ˆë‹¤.

## ğŸ“‹ ë¬¸ì„œ ëª©ë¡

ìµœì‹  ë³€ê²½ì‚¬í•­ë¶€í„° í™•ì¸í•˜ì„¸ìš”.

---

Generated by Code Changelog Tracker
"""
            readme_path.write_text(content, encoding='utf-8')
    
    def log_file_creation(
        self,
        file_path: str,
        content: str,
        reason: str
    ):
        """íŒŒì¼ ìƒì„± ê¸°ë¡"""
        self.changes.append({
            'type': 'creation',
            'file_path': file_path,
            'content': content,
            'reason': reason
        })
    
    def log_file_modification(
        self,
        file_path: str,
        old_content: str,
        new_content: str,
        reason: str
    ):
        """íŒŒì¼ ìˆ˜ì • ê¸°ë¡"""
        self.changes.append({
            'type': 'modification',
            'file_path': file_path,
            'old_content': old_content,
            'new_content': new_content,
            'reason': reason
        })
    
    def log_file_deletion(
        self,
        file_path: str,
        content: str,
        reason: str
    ):
        """íŒŒì¼ ì‚­ì œ ê¸°ë¡"""
        self.changes.append({
            'type': 'deletion',
            'file_path': file_path,
            'content': content,
            'reason': reason
        })
    
    def log_bug_fix(
        self,
        file_path: str,
        old_content: str,
        new_content: str,
        bug_desc: str,
        fix_desc: str
    ):
        """ë²„ê·¸ ìˆ˜ì • ê¸°ë¡"""
        self.changes.append({
            'type': 'bug_fix',
            'file_path': file_path,
            'old_content': old_content,
            'new_content': new_content,
            'bug_desc': bug_desc,
            'fix_desc': fix_desc
        })
    
    def log_refactoring(
        self,
        file_path: str,
        old_content: str,
        new_content: str,
        refactor_type: str,
        reason: str
    ):
        """ë¦¬íŒ©í† ë§ ê¸°ë¡"""
        self.changes.append({
            'type': 'refactoring',
            'file_path': file_path,
            'old_content': old_content,
            'new_content': new_content,
            'refactor_type': refactor_type,
            'reason': reason
        })
    
    def _generate_markdown(self) -> str:
        """Markdown ë¬¸ì„œ ìƒì„±"""
        lines = []
        
        # í—¤ë”
        lines.append(f"# {self.project_name}")
        lines.append("")
        lines.append(f"**ì‘ì„± ì‹œê°„**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        lines.append("")
        
        if self.user_request:
            lines.append(f"**ìš”êµ¬ì‚¬í•­**: {self.user_request}")
            lines.append("")
        
        lines.append("---")
        lines.append("")
        
        # ë³€ê²½ì‚¬í•­ ëª©ë¡
        for i, change in enumerate(self.changes, 1):
            change_type = change['type']
            file_path = change['file_path']
            
            lines.append(f"## {i}. {file_path}")
            lines.append("")
            
            if change_type == 'creation':
                lines.append("**ë³€ê²½ ìœ í˜•**: íŒŒì¼ ìƒì„± âœ¨")
                lines.append("")
                lines.append(f"**ì´ìœ **: {change['reason']}")
                lines.append("")
                lines.append("**ë‚´ìš©**:")
                lines.append("```")
                lines.append(change['content'])
                lines.append("```")
                lines.append("")
            
            elif change_type == 'modification':
                lines.append("**ë³€ê²½ ìœ í˜•**: íŒŒì¼ ìˆ˜ì • âœï¸")
                lines.append("")
                lines.append(f"**ì´ìœ **: {change['reason']}")
                lines.append("")
                lines.append("**ë³€ê²½ ì „**:")
                lines.append("```")
                lines.append(change['old_content'])
                lines.append("```")
                lines.append("")
                lines.append("**ë³€ê²½ í›„**:")
                lines.append("```")
                lines.append(change['new_content'])
                lines.append("```")
                lines.append("")
            
            elif change_type == 'deletion':
                lines.append("**ë³€ê²½ ìœ í˜•**: íŒŒì¼ ì‚­ì œ ğŸ—‘ï¸")
                lines.append("")
                lines.append(f"**ì´ìœ **: {change['reason']}")
                lines.append("")
                lines.append("**ì‚­ì œëœ ë‚´ìš©**:")
                lines.append("```")
                lines.append(change['content'])
                lines.append("```")
                lines.append("")
            
            elif change_type == 'bug_fix':
                lines.append("**ë³€ê²½ ìœ í˜•**: ë²„ê·¸ ìˆ˜ì • ğŸ›")
                lines.append("")
                lines.append(f"**ë²„ê·¸ ì„¤ëª…**: {change['bug_desc']}")
                lines.append(f"**ìˆ˜ì • ë‚´ìš©**: {change['fix_desc']}")
                lines.append("")
                lines.append("**ë³€ê²½ ì „**:")
                lines.append("```")
                lines.append(change['old_content'])
                lines.append("```")
                lines.append("")
                lines.append("**ë³€ê²½ í›„**:")
                lines.append("```")
                lines.append(change['new_content'])
                lines.append("```")
                lines.append("")
            
            elif change_type == 'refactoring':
                lines.append("**ë³€ê²½ ìœ í˜•**: ë¦¬íŒ©í† ë§ â™»ï¸")
                lines.append("")
                lines.append(f"**ë¦¬íŒ©í† ë§ ìœ í˜•**: {change['refactor_type']}")
                lines.append(f"**ì´ìœ **: {change['reason']}")
                lines.append("")
                lines.append("**ë³€ê²½ ì „**:")
                lines.append("```")
                lines.append(change['old_content'])
                lines.append("```")
                lines.append("")
                lines.append("**ë³€ê²½ í›„**:")
                lines.append("```")
                lines.append(change['new_content'])
                lines.append("```")
                lines.append("")
            
            lines.append("---")
            lines.append("")
        
        # í‘¸í„°
        lines.append(f"**ì´ ë³€ê²½ì‚¬í•­**: {len(self.changes)}ê°œ")
        lines.append("")
        
        return "\n".join(lines)
    
    def save_review(self) -> Path:
        """ë¦¬ë·° ë¬¸ì„œ ì €ì¥"""
        if not self.changes:
            print("âš ï¸  ê¸°ë¡ëœ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.")
            return None
        
        # Markdown ìƒì„±
        markdown = self._generate_markdown()
        
        # íŒŒì¼ ì €ì¥
        file_path = self.reviews_dir / f"{self.timestamp}.md"
        file_path.write_text(markdown, encoding='utf-8')
        
        print(f"âœ“ ë³€ê²½ ì´ë ¥ ì €ì¥: {file_path}")
        return file_path
    
    def update_summary(self):
        """SUMMARY.md ì—…ë°ì´íŠ¸"""
        summary_path = self.reviews_dir / "SUMMARY.md"
        
        # ëª¨ë“  MD íŒŒì¼ ì°¾ê¸° (README, SUMMARY ì œì™¸)
        md_files = sorted(
            [f for f in self.reviews_dir.glob("*.md") 
             if f.name not in ["README.md", "SUMMARY.md"]],
            reverse=True  # ìµœì‹ ìˆœ
        )
        
        lines = [
            "# Summary",
            "",
            "* [í™ˆ](README.md)",
            ""
        ]
        
        for md_file in md_files:
            # íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì½ê¸° ì¢‹ì€ í˜•ì‹ìœ¼ë¡œ
            timestamp = md_file.stem
            try:
                dt = datetime.strptime(timestamp, "%Y%m%d_%H%M%S")
                display_name = dt.strftime("%Y-%m-%d %H:%M:%S")
            except:
                display_name = timestamp
            
            lines.append(f"* [{display_name}]({md_file.name})")
        
        summary_path.write_text("\n".join(lines), encoding='utf-8')
        print(f"âœ“ SUMMARY.md ì—…ë°ì´íŠ¸: {len(md_files)}ê°œ ë¬¸ì„œ")
    
    def update_index_html(self):
        """index.html ì—…ë°ì´íŠ¸"""
        index_path = self.reviews_dir / "index.html"
        
        # ëª¨ë“  MD íŒŒì¼ ì°¾ê¸° (README, SUMMARY ì œì™¸)
        md_files = sorted(
            [f for f in self.reviews_dir.glob("*.md") 
             if f.name not in ["README.md", "SUMMARY.md"]],
            reverse=True  # ìµœì‹ ìˆœ
        )
        
        # íŒŒì¼ ëª©ë¡ ìƒì„±
        file_list_items = []
        for i, md_file in enumerate(md_files):
            timestamp = md_file.stem
            try:
                dt = datetime.strptime(timestamp, "%Y%m%d_%H%M%S")
                display_name = dt.strftime("%Y-%m-%d %H:%M:%S")
            except:
                display_name = timestamp
            
            active_class = " class='active'" if i == 0 else ""
            file_list_items.append(
                f"        <li{active_class}><a href='#{md_file.name}'>{display_name}</a></li>"
            )
        
        file_list_html = "\n".join(file_list_items)
        
        # ê¸°ë³¸ íŒŒì¼ (ìµœì‹  íŒŒì¼)
        default_file = md_files[0].name if md_files else "README.md"
        
        # HTML í…œí”Œë¦¿
        html_content = f"""<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{self.project_name} - ì½”ë“œ ë³€ê²½ ì´ë ¥</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            display: flex;
            height: 100vh;
        }}
        
        .sidebar {{
            width: 280px;
            background: #161b22;
            border-right: 1px solid #30363d;
            overflow-y: auto;
            padding: 20px;
        }}
        
        .sidebar h2 {{
            color: #58a6ff;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #30363d;
        }}
        
        .sidebar ul {{
            list-style: none;
        }}
        
        .sidebar li {{
            margin: 5px 0;
        }}
        
        .sidebar a {{
            color: #8b949e;
            text-decoration: none;
            display: block;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 14px;
        }}
        
        .sidebar a:hover {{
            background: #21262d;
            color: #58a6ff;
        }}
        
        .sidebar li.active a {{
            background: #1f6feb;
            color: #fff;
        }}
        
        .content {{
            flex: 1;
            overflow-y: auto;
            padding: 40px;
        }}
        
        .markdown-body {{
            max-width: 980px;
            margin: 0 auto;
        }}
        
        .markdown-body h1 {{
            color: #c9d1d9;
            border-bottom: 1px solid #21262d;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }}
        
        .markdown-body h2 {{
            color: #58a6ff;
            margin-top: 30px;
            margin-bottom: 15px;
        }}
        
        .markdown-body h3 {{
            color: #8b949e;
            margin-top: 20px;
            margin-bottom: 10px;
        }}
        
        .markdown-body p {{
            line-height: 1.6;
            margin-bottom: 15px;
        }}
        
        .markdown-body code {{
            background: #161b22;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 85%;
            color: #f0883e;
        }}
        
        .markdown-body pre {{
            background: #161b22;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid #30363d;
        }}
        
        .markdown-body pre code {{
            background: none;
            padding: 0;
            color: #c9d1d9;
        }}
        
        .markdown-body hr {{
            border: none;
            border-top: 1px solid #21262d;
            margin: 30px 0;
        }}
        
        .markdown-body strong {{
            color: #fff;
        }}
        
        .markdown-body ul {{
            margin-left: 20px;
            margin-bottom: 15px;
        }}
        
        .markdown-body li {{
            margin: 5px 0;
        }}
        
        .loading {{
            text-align: center;
            padding: 50px;
            color: #8b949e;
        }}
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>ğŸ“‹ ë³€ê²½ ì´ë ¥</h2>
        <ul id="file-list">
{file_list_html}
        </ul>
    </div>
    
    <div class="content">
        <div id="markdown-content" class="markdown-body">
            <div class="loading">ë¬¸ì„œ ë¡œë”© ì¤‘...</div>
        </div>
    </div>
    
    <script>
        const contentDiv = document.getElementById('markdown-content');
        const fileList = document.getElementById('file-list');
        
        // Markdown íŒŒì¼ ë¡œë“œ ë° ë Œë”ë§
        async function loadMarkdown(filename) {{
            try {{
                const response = await fetch(filename);
                const markdown = await response.text();
                contentDiv.innerHTML = marked.parse(markdown);
                
                // í™œì„± ë§í¬ ì—…ë°ì´íŠ¸
                fileList.querySelectorAll('li').forEach(li => li.classList.remove('active'));
                const activeLink = fileList.querySelector(`a[href="#${{filename}}"]`);
                if (activeLink) {{
                    activeLink.parentElement.classList.add('active');
                }}
                
                // URL ì—…ë°ì´íŠ¸
                window.location.hash = filename;
            }} catch (error) {{
                contentDiv.innerHTML = '<div class="loading">âŒ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }}
        }}
        
        // ë§í¬ í´ë¦­ ì´ë²¤íŠ¸
        fileList.addEventListener('click', (e) => {{
            if (e.target.tagName === 'A') {{
                e.preventDefault();
                const filename = e.target.getAttribute('href').substring(1);
                loadMarkdown(filename);
            }}
        }});
        
        // ì´ˆê¸° ë¡œë“œ (URL í•´ì‹œ ë˜ëŠ” ê¸°ë³¸ íŒŒì¼)
        const initialFile = window.location.hash.substring(1) || '{default_file}';
        loadMarkdown(initialFile);
    </script>
</body>
</html>
"""
        
        index_path.write_text(html_content, encoding='utf-8')
        print(f"âœ“ index.html ì—…ë°ì´íŠ¸: {len(md_files)}ê°œ ë¬¸ì„œ")
    
    def save_and_build(self) -> Path:
        """ì €ì¥ + SUMMARY ì—…ë°ì´íŠ¸ + index.html ì—…ë°ì´íŠ¸"""
        file_path = self.save_review()
        if file_path:
            self.update_summary()
            self.update_index_html()
        return file_path
    
    def serve_docs(self):
        """ë¬¸ì„œ ì„œë²„ ì‹¤í–‰"""
        print(f"\nğŸŒ ë¬¸ì„œ ì„œë²„ ì‹¤í–‰ ì¤‘...")
        print(f"   URL: http://localhost:{self.port}")
        print(f"   ì¢…ë£Œ: Ctrl+C\n")
        
        try:
            subprocess.run(
                ["python3", "-m", "http.server", str(self.port)],
                cwd=self.reviews_dir
            )
        except KeyboardInterrupt:
            print("\nâœ“ ì„œë²„ ì¢…ë£Œ")


def main():
    """ëª…ë ¹ì¤„ ì¸í„°í˜ì´ìŠ¤"""
    import sys
    
    if len(sys.argv) < 2:
        print("ì‚¬ìš©ë²•:")
        print("  python code_changelog_tracker.py init     # ì´ˆê¸°í™”")
        print("  python code_changelog_tracker.py build    # SUMMARY + index.html ì—…ë°ì´íŠ¸")
        print("  python code_changelog_tracker.py serve    # ë¬¸ì„œ ì„œë²„ ì‹¤í–‰")
        return
    
    command = sys.argv[1]
    
    logger = CodeChangeLogger("Project")
    
    if command == "init":
        print("âœ“ reviews ë””ë ‰í† ë¦¬ ì´ˆê¸°í™” ì™„ë£Œ")
    
    elif command == "build":
        logger.update_summary()
        logger.update_index_html()
        print("âœ“ ë¹Œë“œ ì™„ë£Œ")
    
    elif command == "serve":
        port = int(sys.argv[2]) if len(sys.argv) > 2 else 4000
        logger.port = port
        logger.serve_docs()
    
    else:
        print(f"âŒ ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹: {command}")


if __name__ == "__main__":
    main()

